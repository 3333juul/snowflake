#!/bin/bash

# config
ipc=on
splash=false

# Find all wallpapers
wallpapers=$(find "$HOME/Pictures/Backgrounds" -type f)

# Show menu (with icon) for wallpaper selection
selected_wallpaper=$(for a in $wallpapers; do
    echo -en "${a##*/}\0icon\x1f$a\n"
done | rofi -dmenu -i -p "WALLPAPER" -theme ~/.config/rofi/themes/wallpaper.rasi)

# if a wallpaper is selected
if [[ -n $selected_wallpaper ]]; then
    # get monitor names
    monitors=$(hyprctl -j monitors | jq -r '.[].name')

    # count the number of monitors
    monitor_count=$(echo "$monitors" | wc -l)
    
    # show menu for monitor selection with dynamic lines
    selected_monitor=$(for monitor in $monitors; do
        echo -en "$monitor\n"
    done | rofi -dmenu -p "MONITOR" -theme ~/.config/rofi/themes/wallpaper.rasi -no-show-icons -theme-str "window { width: 350px; } listview { lines: $monitor_count; columns: 1;}")
    
    # if a monitor is selected
    if [[ -n $selected_monitor ]]; then
        # get the current wallpaper path
        current_wallpaper_path=$(hyprctl hyprpaper listactive | grep "$selected_monitor" | awk -F ' = ' '{print $2}')
        current_wallpaper_name=$(basename "$current_wallpaper_path")

        # unload the current wallpaper (if exists)
        if [[ -n $current_wallpaper_path ]]; then
            hyprctl hyprpaper unload "$current_wallpaper_path"
        fi

        # preload and set the new wallpaper
        hyprctl hyprpaper preload "$HOME/Pictures/Backgrounds/$selected_wallpaper"
        hyprctl hyprpaper wallpaper "$selected_monitor,$HOME/Pictures/Backgrounds/$selected_wallpaper"
        
        # Ask if user wants to make the change permanent
        confirm=$(echo -e "No\nYes" | rofi -dmenu -p "Make permanent?" -theme ~/.config/rofi/themes/wallpaper.rasi -no-show-icons -theme-str "window { width: 350px; } listview { lines: 2; columns: 1;}")
        
        # If the user confirms, update the configuration file
        if [[ $confirm == "Yes" ]]; then
            config_file=~/.config/hypr/hyprpaper.conf
            
            # Clear the configuration file
            > "$config_file"
            
            echo "# Content of this file was automatically generated by $(basename "$0") script" >> "$config_file"
            echo "" >> "$config_file"

            # Add headings and settings
            echo "# preload" >> "$config_file"
            
            # Preload all active wallpapers
            hyprctl hyprpaper listactive | while IFS=' = ' read -r monitor path; do
                echo "preload = ~${path#"$HOME"}" >> "$config_file"
            done
            
            echo "" >> "$config_file"
            echo "# set" >> "$config_file"
            
            # Set all active wallpapers
            hyprctl hyprpaper listactive | while IFS=' = ' read -r monitor path; do
                echo "wallpaper = $monitor, ~${path#"$HOME"}" >> "$config_file"
            done

            # config
            echo "" >> "$config_file"
            echo "# config" >> "$config_file"
            echo "ipc = $ipc" >> "$config_file"
            echo "splash = $splash" >> "$config_file"
        fi
    fi
fi
